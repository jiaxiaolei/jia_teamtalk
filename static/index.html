<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>企业级沟通翻译助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen p-8">
    <div class="max-w-5xl mx-auto grid grid-cols-2 gap-8">
        <!-- 输入区 -->
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-xl font-bold mb-4 text-slate-700">输入 Context</h2>
            <select id="roleType" class="w-full mb-4 p-2 border rounded">
                <option value="p2d">产品经理 ➔ 开发视角</option>
                <option value="d2p">开发工程师 ➔ 商业视角</option>
            </select>
            <textarea id="inputContent" class="w-full h-64 p-3 border rounded mb-4" placeholder="请输入..."></textarea>
            <button onclick="startStream()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                开始转换
            </button>
        </div>

        <!-- 输出区 -->
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-xl font-bold mb-4 text-slate-700">AI 翻译结果</h2>
            <div id="output" class="prose prose-sm max-w-none text-slate-600 leading-relaxed">
                <span class="text-gray-400 italic">等待生成...</span>
            </div>
        </div>
    </div>

    <script>
        async function startStream() {
            const roleType = document.getElementById('roleType').value;
            const content = document.getElementById('inputContent').value;
            const outputDiv = document.getElementById('output');
            
            if(!content) return;

            outputDiv.innerHTML = ''; // 清空
            let fullText = ""; // 用于 Markdown 解析的累积文本

            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ direction: roleType, content: content })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // 获取增量文本 (Delta)
                    const chunk = decoder.decode(value, { stream: true });
                    
                    // 累积文本并实时渲染 Markdown
                    fullText += chunk;
                    outputDiv.innerHTML = marked.parse(fullText);
                }
            } catch (e) {
                outputDiv.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
            }
        }
    </script>
</body>
</html>
